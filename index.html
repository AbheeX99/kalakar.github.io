<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalakar - Authentic Nepali Crafts</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/lucide-icons@latest/dist/lucide.min.js"></script>

    <style>
        /* --- Base & Font Styles --- */
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #FFFBF5; 
            scroll-behavior: smooth;
            transition: background-image 0.5s ease-in-out;
            background-size: cover;
            background-attachment: fixed;
        }
        .font-display { font-family: 'Playfair Display', serif; font-weight: 800; }

        /* --- Dynamic Backgrounds --- */
        .default-bg {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .jewelry-bg {
            background-image: linear-gradient(rgba(255, 251, 245, 0.85), rgba(255, 251, 245, 0.85)), url(https://images.pexels.com/photos/248077/pexels-photo-248077.jpeg);
        }
        .cosmetics-bg {
            background-image: linear-gradient(rgba(255, 251, 245, 0.8), rgba(255, 251, 245, 0.8)), url(https://images.pexels.com/photos/1749452/pexels-photo-1749452.jpeg);
        }

        /* --- Page Scroll Progress Bar --- */
        #scroll-progress-bar-container {
            position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
            height: 200px; width: 4px; background-color: rgba(0,0,0,0.1);
            border-radius: 2px; z-index: 9999; opacity: 0; transition: opacity 0.3s;
        }
        body.scrolling #scroll-progress-bar-container { opacity: 1; }
        #scroll-progress-bar { width: 100%; height: 0; background-color: #7C3AED; border-radius: 2px; }

        /* --- Animation & Transition Utilities --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes popIn {
            from { transform: scale(0.95) translateY(10px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slide-in-up { opacity: 0; animation: slideInUp 0.6s ease-out forwards; }
        
        /* --- Component Styles --- */
        .modal-backdrop { background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; }
        .modal-content-scroll { max-height: 85vh; overflow-y: auto; }
        .sidebar { transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); transform: translateX(100%); }
        .sidebar.open { transform: translateX(0); }
        .wishlist-toggle-btn.active i { color: #ef4444; fill: #ef4444; }
        .heart-shape {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 2px solid #d1d5db; /* gray-300 */
            border-radius: 50%; /* Makes it a circle, a good base for a heart button */
            transition: all 0.2s ease;
        }
        .heart-shape:hover {
            border-color: #fca5a5; /* red-300 */
        }
        .heart-shape.active {
            border-color: #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
        }
        .heart-shape.active i {
             color: #ef4444; fill: #ef4444;
        }


        /* --- Product Card Advanced Hover & Classy Touch --- */
        .product-card { 
            position: relative; 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            border: 1px solid #f0e9e9;
            border-radius: 1rem;
        }
        .product-card:hover { 
            transform: translateY(-10px); 
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); 
            z-index: 10; 
            border-color: #e2d1f8; 
        }
        .product-card .actions-overlay { opacity: 0; transition: opacity 0.3s ease; }
        .product-card:hover .actions-overlay { opacity: 1; }
        .product-card .action-button { transform: translateY(10px); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; }
        .product-card:hover .action-button { transform: translateY(0); opacity: 1; }
        .product-card .tag { position: absolute; top: 12px; left: 12px; padding: 4px 8px; font-size: 10px; font-weight: bold; text-transform: uppercase; border-radius: 4px; z-index: 2; }
        .tag.premium { background-color: #d97706; color: white; }
        
        /* --- Category Choice Section --- */
        .category-choice-card { transition: transform 0.3s, box-shadow 0.3s; }
        .category-choice-card:hover { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2); }
        
        /* --- Payment & Delivery Method Selection --- */
        .payment-option, .delivery-option {
            border: 2px solid #e5e7eb;
            transition: border-color 0.2s;
            cursor: pointer;
        }
        .payment-option.selected, .delivery-option.selected {
            border-color: #7c3aed;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #fffbf5; }
        ::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #7c3aed; }

        /* --- Filter Styles --- */
        .filter-section { border-bottom: 1px solid #e5e7eb; padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
        .filter-section:last-child { border-bottom: none; }
        .filter-section h3 { font-weight: 600; margin-bottom: 1rem; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 4px; background: #d1d5db; border-radius: 2px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #7c3aed; border-radius: 50%; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: #7c3aed; border-radius: 50%; cursor: pointer; }

    </style>
</head>
<body class="text-gray-800 default-bg">
    <div id="scroll-progress-bar-container"><div id="scroll-progress-bar"></div></div>
    
    <div id="app" class="relative max-w-screen-2xl mx-auto">
        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-30 shadow-md border-b border-gray-200"></header>
        <main>
            <section id="category-choice"></section>
            <div id="shop-content" class="hidden"></div>
        </main>
        <div id="modal-container" class="fixed inset-0 z-50 pointer-events-none"></div>
        <div id="sidebar-container" class="fixed top-0 right-0 h-full z-40 pointer-events-none"></div>
        <div id="toast-container" class="fixed bottom-5 right-5 z-[10000] space-y-2"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================================
        // I. DATABASE & STATE
        // ===================================================================================
        const db = {
            products: [
                 // Jewelry
                 { id: "J001", mainCat: "Jewelry", category: "Rings", name: "Patan Silver Mandala Ring", price: 2500, images: ["https://cdn.mysagestore.com/74db5e032e6fecb07f3130f646bb2751/contents/R167/R167SZ8_SVRING.jpg"], spec: "Hand-carved by Patan artisans, pure 925 sterling silver.", description: "This exquisite ring is a testament to the master craftsmanship of Patan's artisans. Featuring a detailed Mandala design on pure 925 sterling silver, it embodies spiritual symbolism and timeless elegance. Perfect for daily wear or special occasions.", tags: ['featured', 'high-demand'], stock: 15, sizes: ["6", "7", "8", "9"] },
                { id: "J002", mainCat: "Jewelry", category: "Rings", name: "Premium Gold Weave Ring", price: 12500, images: ["https://goldarts.co.uk/cdn/shop/files/22-10-24jewellery_24_1800x1800.jpg?v=1729674224"], spec: "Intricate weave pattern, hallmarked 22k gold.", description: "A luxurious piece for those who appreciate fine detail. This ring features an intricate weave pattern, meticulously crafted from hallmarked 22k gold. Its robust design and radiant shine make it a statement of pure sophistication.", tags: ['premium'], stock: 5, sizes: ["7", "8"] },
                { id: "J003", mainCat: "Jewelry", category: "Necklaces", name: "Tibetan Turquoise Necklace", price: 4500, images: ["https://classicrockcouture.com/cdn/shop/files/IMG-0842_grande.jpg?v=1706037703"], spec: "Polished Tibetan turquoise on a silver chain.", description: "Capture the essence of the Himalayas with this stunning necklace. It features genuine, polished Tibetan turquoise stones, known for their vibrant color and protective properties, set on a delicate yet durable silver chain.", tags: ['featured', 'festive-sale'], stock: 20, colors: ["Blue", "Green-Blue"] },
                { id: "J005", mainCat: "Jewelry", category: "Earrings", name: "Pearl Stud Earrings", price: 950, images: ["http://images.squarespace-cdn.com/content/v1/608a705d359126541d56050a/1648563094750-TZ8D3YVPJA762V6EH1E3/gold-stud-earrings-dots-Militza-Ortiz-Jewellery.jpg"], spec: "Classic pearl studs for everyday elegance.", description: "Simplicity at its finest. These classic pearl stud earrings are a must-have in any jewelry collection. Their lustrous shine and timeless design provide a touch of elegance to any outfit, from casual to formal.", tags: ['affordable', 'high-demand'], stock: 50 },
                { id: "J008", mainCat: "Jewelry", category: "Anklets", name: "Silver Ghungroo Anklet", price: 2100, images: ["https://assets.myntassets.com/fl_progressive/h_960,q_80,w_720/v1/assets/images/9643855/2019/7/12/b21f0fb9-199c-4c4c-993e-10e035963fcb1562931641544-Priyaasi-Set-of-2-Oxidised-German-Silver-Ghungroo-Anklets-wi-1.jpg"], spec: "Traditional silver anklet with tiny sonorous bells.", description: "Embrace tradition with the gentle chime of this silver Ghungroo anklet. Each tiny bell is carefully attached to a beautifully crafted silver chain, creating a piece that is both visually and audibly delightful.", tags: ['featured'], stock: 18 },
                { id: "J014", mainCat: "Jewelry", category: "Earrings", name: "Classic Jhumka Earrings", price: 4200, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQqT23JA8jm_1cMNcxgdFqMY9tjm5Pry-dX4g&s"], spec: "Classic tiered jhumka earrings with pearl drops.", description: "A celebration of heritage design, these tiered jhumka earrings are a festive essential. Intricately detailed and finished with delicate pearl drops, they sway gracefully with every movement.", tags: ['featured', 'festive-sale'], stock: 14 },
                { id: "J015", mainCat: "Jewelry", category: "Pendant Sets", name: "Filigree Pendant Set", price: 5800, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTLbt8WyHnjGfcSXZiBMbve262I_jdP-YMbtQ&s"], spec: "Delicate silver filigree work, with matching earrings.", description: "Showcasing the delicate art of filigree, this pendant set is a masterpiece of precision. The intricate floral design, crafted from fine silver threads, comes with perfectly matching earrings for a complete, elegant look.", tags: ['new-arrival'], stock: 10 },
                { id: "J016", mainCat: "Jewelry", category: "Brooches", name: "Enamel Peacock Brooch", price: 3200, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTb_fOgYI9Rv7_klV2-zjKAxQd3txNrBm_dYw&s"], spec: "Vibrant enamel work on a beautifully crafted peacock brooch.", description: "Add a splash of color and artistry to your attire with this enamel peacock brooch. The vibrant colors and detailed craftsmanship capture the majestic beauty of Nepal's national bird.", tags: [], stock: 25 },
                { id: "J017", mainCat: "Jewelry", category: "Nose Pins", name: "Golden Sun Nose Pin", price: 1800, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT631OcagG5IMgXy_2VQesMc4MlbYk_uG5tMA&s"], spec: "A simple yet elegant 18k gold plated sun motif nose pin.", description: "Shine bright with this elegant Golden Sun nose pin. The simple yet striking sun motif is plated in 18k gold, offering a touch of understated glamour for a modern, chic look.", tags: ['affordable', 'high-demand'], stock: 40 },
                { id: "J018", mainCat: "Jewelry", category: "Bracelets", name: "Seven-Chakra Bracelet", price: 2200, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTxnXMRth7CktTPJ9TJN3coYNtpFNE_yF-C4g&s"], spec: "Features seven different semi-precious stones.", description: "Align your energy with this beautiful Seven-Chakra bracelet. It features seven carefully selected semi-precious stones, each representing one of the body's energy centers. A meaningful and stylish accessory.", tags: ['new-arrival', 'featured'], stock: 30, colors: ["Multicolor"] },
                { id: "J019", mainCat: "Jewelry", category: "Necklaces", name: "Traditional Chandra Haar", price: 18500, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcShIoIfdOUqjhQ4kG3d_S49OQnl_yNjuRTWqQ&s"], spec: "A majestic multi-layered necklace, embodying Nepali heritage.", description: "The Chandra Haar is the epitome of Nepali bridal and festive wear. This majestic, multi-layered necklace is a symbol of prosperity and heritage, crafted with exceptional attention to detail to be treasured for generations.", tags: ['premium', 'festive-sale'], stock: 4 },

                // Cosmetics
                { id: "C001", mainCat: "Cosmetics", category: "Skincare", name: "Mustang Rose Water Mist", price: 1200, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTHDC5Cnqx-Jldt66PZ4fH4F4qRm0cB4PrKEg&s"], spec: "100% pure steam-distilled rose water from Mustang.", description: "Refresh and hydrate your skin with the purest rose water from the high-altitude roses of Mustang. This 100% pure, steam-distilled mist tones, soothes, and revitalizes, leaving your skin with a natural, dewy glow.", tags: ['featured', 'high-demand'], stock: 40 },
                { id: "C002", mainCat: "Cosmetics", category: "Skincare", name: "High-Himalayan Juniper Soap", price: 800, images: ["https://himalayanmartonline.com/wp-content/uploads/2018/03/hotsprings-juniper-1.jpg"], spec: "Handmade soap with wild-harvested juniper for cleansing.", description: "Experience a purifying cleanse with our handmade Juniper soap. Made with wild-harvested juniper from the High Himalayas, it has natural antiseptic properties that leave your skin feeling clean, fresh, and invigorated.", tags: ['affordable', 'new-arrival'], stock: 60 },
                { id: "C003", mainCat: "Cosmetics", category: "Makeup", name: "Natural Gajal Eyeliner", price: 600, images: ["https://naturalmum.com.au/cdn/shop/files/benecos-kajal-eyeliner-1-13g-9-colours-makeup-1-336.webp?v=1736486481"], spec: "Soothes and defines eyes, made with natural ingredients.", description: "Define your eyes the traditional way with our Natural Gajal. Made from a blend of natural ingredients and soothing oils, it glides on smoothly to create a bold, dramatic look while also nourishing the delicate eye area.", tags: ['affordable'], stock: 100 },
                { id: "C005", mainCat: "Cosmetics", category: "Makeup", name: "Beetroot Lip & Cheek Tint", price: 1100, images: ["https://www.moncornerb.com/24704-product_cover/organic-beetroot-cheek-lip-tint-ere-perez.jpg"], spec: "Natural, buildable color from beetroot extracts.", description: "Get a healthy, natural flush with our Beetroot Lip & Cheek Tint. This versatile product provides a buildable, long-lasting color from natural beetroot extracts. It's lightweight, non-sticky, and perfect for a sheer or bold look.", tags: ['new-arrival', 'high-demand'], stock: 35 },
                { id: "C006", mainCat: "Cosmetics", category: "Skincare", name: "Saffron & Turmeric Face Pack", price: 1800, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS5KuuYFmKZuhxkhhcbvy0N4EEhlfPt8vaKCw&s"], spec: "A brightening face pack for radiant, glowing skin.", description: "Unveil your skin's natural radiance. This luxurious face pack combines the brightening powers of saffron and the purifying properties of turmeric to improve complexion, reduce blemishes, and leave your skin glowing.", tags: ['premium', 'featured'], stock: 15 },
                { id: "C007", mainCat: "Cosmetics", category: "Hair Care", name: "Bhringraj Herbal Hair Oil", price: 1650, images: ["https://www.biotique.com/cdn/shop/files/8904352004568_2-min_c9676cd8-5feb-4a52-9db2-59d5fdfae1ea.jpg?v=1670245366"], spec: "An ancient Ayurvedic recipe for hair strength and vitality.", description: "Revitalize your hair with this ancient Ayurvedic recipe. Our Bhringraj Herbal Hair Oil is a potent blend of herbs known to strengthen roots, reduce hair fall, and promote healthy, lustrous growth.", tags: ['new-arrival'], stock: 28 },
                { id: "C008", mainCat: "Cosmetics", category: "Skincare", name: "Shea & Chiuri Butter Body Lotion", price: 1950, images: ["https://www.lavenour.com/cdn/shop/files/shea_butter_body_lotion_600x600.webp?v=1725103589"], spec: "Deeply moisturizing lotion with wild-harvested Chiuri butter.", description: "Indulge your skin in deep hydration with this rich body lotion. It combines the nourishing properties of Shea butter with wild-harvested Chiuri butter from Nepal, leaving your skin soft, supple, and moisturized all day.", tags: [], stock: 22 },
                { id: "C009", mainCat: "Cosmetics", category: "Makeup", name: "Mint & Beeswax Lip Balm", price: 550, images: ["https://static.wixstatic.com/media/cd8cb9_91c7947f62ad458e8188c55687aabb6d~mv2_d_4912_3264_s_4_2.jpg/v1/fill/w_520,h_346,al_c,q_80,usm_0.66_1.00_0.01,enc_avif,quality_auto/cd8cb9_91c7947f62ad458e8188c55687aabb6d~mv2_d_4912_3264_s_4_2.jpg"], spec: "A refreshing and protective lip balm made with pure beeswax.", description: "Protect and soothe your lips with our Mint & Beeswax Lip Balm. Pure, natural beeswax forms a protective barrier, while a hint of mint provides a refreshing tingle. Keeps lips hydrated and chap-free.", tags: ['affordable', 'high-demand'], stock: 70 },
                { id: "C010", mainCat: "Cosmetics", category: "Hair Care", name: "Rittha & Shikakai Shampoo", price: 1400, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSuaTWR814NxK7UT0OAplur84f8rqRa_FfkWw&s"], spec: "A natural, cleansing shampoo that's gentle on your scalp.", description: "Cleanse your hair naturally with the power of Rittha (Soapnut) and Shikakai. This traditional shampoo is free from harsh chemicals, gently cleanses the scalp, removes impurities, and adds natural shine and bounce to your hair.", tags: ['new-arrival'], stock: 33 },
                { id: "C011", mainCat: "Cosmetics", category: "Skincare", name: "Sandalwood Soothing Gel", price: 1300, images: ["https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR3dyzvaamxoRQLjuniw7LUI4nYN1vMsKyoww&s"], spec: "A light, cooling gel perfect for calming irritated skin.", description: "Calm and cool your skin with this light Sandalwood Soothing Gel. Known for its anti-inflammatory and cooling properties, sandalwood helps to reduce redness and irritation, making it perfect for sensitive or sun-exposed skin.", tags: ['featured'], stock: 18 },
            ],
            cart: [], wishlist: [], orders: [],
        };
        const state = { 
            activeCategory: null,
            activeProduct: null,
            isLoggedIn: false,
            customerName: 'Guest',
            selectedPaymentMethod: 'cod',
            deliveryCharge: 0, 
            orderCounter: 1,
            filters: {}
        };

        // ===================================================================================
        // II. DOM ELEMENT SELECTORS & HELPERS
        // ===================================================================================
        const getEl = (id) => document.getElementById(id);
        const headerEl = document.querySelector('header');
        const mainEl = document.querySelector('main');
        const modalContainer = getEl('modal-container');
        const sidebarContainer = getEl('sidebar-container');
        const toastContainer = getEl('toast-container');
        const shopContent = getEl('shop-content');
        const categoryChoice = getEl('category-choice');
        
        // ===================================================================================
        // III. RENDER & UI FUNCTIONS
        // ===================================================================================
        const showToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'info' ? 'bg-blue-500' : 'bg-red-500';
            toast.className = `pop-in ${bgColor} text-white text-sm font-semibold py-2 px-4 rounded-full shadow-lg`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'popIn 0.5s reverse forwards';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };
        
        const renderHeader = () => {
             const loginButtonHTML = state.isLoggedIn
                 ? `<div class="flex items-center gap-2">
                     <img src="https://placehold.co/32x32/8A2BE2/FFFFFF?text=${state.customerName.charAt(0).toUpperCase()}" alt="User" class="w-8 h-8 rounded-full border-2 border-violet-200">
                     <span class="font-semibold text-gray-700 hidden sm:block">${state.customerName}</span>
                     <button id="logout-btn" class="text-sm font-medium text-gray-600 hover:text-violet-600 ml-2">Logout</button>
                   </div>`
                 : `<button id="login-btn" class="bg-violet-600 text-white px-4 py-2 rounded-md font-semibold text-sm hover:bg-violet-700 transition-all duration-300">Login</button>`;

             headerEl.innerHTML = `
                 <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                     <a href="#" id="brand-logo" class="font-display text-3xl text-violet-800">Kalakar</a>
                     
                     <div class="flex-1 max-w-xl mx-4 hidden md:block">
                         <form id="search-form" class="relative">
                             <input type="search" id="search-input-desktop" placeholder="Search for products..." class="w-full p-2 pl-10 border border-gray-300 rounded-full focus:ring-2 focus:ring-violet-300 focus:border-violet-300 transition-all">
                             <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                         </form>
                     </div>

                     <div class="hidden md:flex items-center space-x-6">
                         <button id="wishlist-btn" class="relative flex items-center gap-2 text-gray-600 hover:text-violet-600">
                             <i data-lucide="heart" class="w-6 h-6"></i>
                             <span class="hidden lg:block ml-1">Wishlist</span>
                             <span id="wishlist-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">${db.wishlist.length}</span>
                         </button>
                         <button id="cart-btn" class="relative flex items-center gap-2 text-gray-600 hover:text-violet-600">
                            <i data-lucide="shopping-bag" class="w-6 h-6"></i>
                            <span class="hidden lg:block ml-1">Cart</span>
                            <span id="cart-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">${db.cart.reduce((sum, item) => sum + item.quantity, 0)}</span>
                         </button>
                     </div>

                     <div class="flex items-center gap-2 md:gap-4 md:ml-4">
                         ${loginButtonHTML}
                         <div class="md:hidden flex items-center">
                             <button id="mobile-search-btn" class="relative text-gray-600 p-2"><i data-lucide="search"></i></button>
                             <button id="mobile-wishlist-btn" class="relative text-gray-600 p-2"><i data-lucide="heart"></i><span class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">${db.wishlist.length}</span></button>
                             <button id="mobile-cart-btn" class="relative text-gray-600 p-2"><i data-lucide="shopping-cart"></i><span class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">${db.cart.reduce((sum, item) => sum + item.quantity, 0)}</span></button>
                         </div>
                     </div>
                 </div>`;
        };

        const getFooterHTML = () => {
            const tiktokIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tiktok"><path d="M12.52 15.04L8.5 13.51A2.5 2.5 0 0 1 11 9.04V8a3 3 0 0 0-3-3H6v11c0 1.1.9 2 2 2h2c1.1 0 2-.9 2-2v-3.04c.1-.02.2-.04.3-.06.2-.1.4-.2.6-.4l.8.8c.2.2.4.3.7.4.3.1.6 0 .9-.1l1-1.73c.3-.5.2-1.1-.2-1.4l-.8-.8c.1-.2.2-.4.4-.6.2-.2.4-.4.6-.6.3-.3.6-.6.8-1 .1-.3 0-.6-.1-.9l-1.73-1c-.5-.3-1.1-.2-1.4.2l-.8.8c-.2-.1-.4-.2-.6-.4-.2-.2-.4-.4-.6-.6-.3-.3-.6-.6-1-.8-.3-.1-.6 0-.9.1l-1.73 1c-.5.3-.6 1-.2 1.4l.8.8c.1.2.2.4.4.6.2.2.4.4.6.6l-2.02 1.53Z"/></svg>`;
            return `
                 <footer class="bg-white/30 backdrop-blur-sm text-violet-900 p-10 mt-16 border-t border-violet-100">
                     <div class="container mx-auto grid grid-cols-1 md:grid-cols-4 gap-8 text-center md:text-left">
                         <div>
                             <h3 class="font-display text-2xl mb-2">Kalakar</h3>
                             <p class="text-gray-700 text-sm">Authentic crafts from the heart of Kathmandu.</p>
                             <div class="mt-4 text-gray-700 text-sm space-y-1">
                                 <p><i data-lucide="phone" class="inline w-4 h-4 mr-2"></i> Helpdesk: +977-9800000000</p>
                                 <p><i data-lucide="message-circle" class="inline w-4 h-4 mr-2"></i> WhatsApp: +977-9811111111</p>
                             </div>
                         </div>
                         <div>
                             <h4 class="font-bold uppercase tracking-wider mb-3">Shop</h4>
                             <a href="#" class="block text-sm hover:text-violet-700 mb-2 category-link" data-category="Jewelry">Jewelry</a>
                             <a href="#" class="block text-sm hover:text-violet-700 mb-2 category-link" data-category="Cosmetics">Cosmetics</a>
                             <a href="#" id="track-order-link" class="block text-sm hover:text-violet-700 mb-2">Track My Order</a>
                         </div>
                         <div>
                             <h4 class="font-bold uppercase tracking-wider mb-3">About</h4>
                             <a href="#" id="our-story-link" class="block text-sm hover:text-violet-700 mb-2">Our Story</a>
                             <a href="#" class="block text-sm hover:text-violet-700 mb-2">Artisans</a>
                             <a href="#" id="contact-us-link" class="block text-sm hover:text-violet-700 mb-2">Contact Us</a>
                         </div>
                         <div>
                              <h4 class="font-bold uppercase tracking-wider mb-3">Follow Us</h4>
                              <div class="flex justify-center md:justify-start space-x-4">
                                  <a href="https://instagram.com" target="_blank" rel="noopener noreferrer" class="hover:text-violet-700"><i data-lucide="instagram"></i></a>
                                  <a href="https://facebook.com" target="_blank" rel="noopener noreferrer" class="hover:text-violet-700"><i data-lucide="facebook"></i></a>
                                  <a href="https://tiktok.com" target="_blank" rel="noopener noreferrer" class="hover:text-violet-700">${tiktokIconSVG}</a>
                              </div>
                         </div>
                     </div>
                     <div class="text-center text-gray-500 text-xs mt-10 border-t border-violet-200 pt-6">
                         &copy; ${new Date().getFullYear()} Kalakar Nepal. All Rights Reserved. Swayambhu, Kathmandu, Nepal.
                     </div>
                 </footer>
             `;
        };
        
        const renderShopLayout = (category) => {
            state.activeCategory = category;
            state.activeProduct = null;
            const productsForCategory = db.products.filter(p => p.mainCat === category);
            resetFilters(productsForCategory);
            
            document.body.className = `text-gray-800 ${category === 'Jewelry' ? 'jewelry-bg' : 'cosmetics-bg'}`;
            categoryChoice.classList.add('hidden');
            shopContent.classList.remove('hidden');

            const pageTitle = `Discover our ${category}`;
            const backButtonHTML = `<button id="back-to-categories" class="flex items-center gap-2 text-violet-600 font-semibold hover:text-violet-800">
                                      <i data-lucide="arrow-left"></i> Back to Categories
                                   </button>`;
            const mobileFilterButton = `<div class="lg:hidden mb-6 text-center">
                                            <button id="mobile-filter-btn" class="bg-white border-2 border-violet-500 text-violet-600 font-semibold py-2 px-6 rounded-full inline-flex items-center gap-2 shadow-sm">
                                                <i data-lucide="filter"></i> Filters
                                            </button>
                                        </div>`;

            shopContent.innerHTML = `
                <div class="container mx-auto px-4 py-12">
                    <div class="flex justify-between items-center mb-8">
                        ${backButtonHTML}
                        <h1 class="font-display text-4xl md:text-5xl text-violet-900 text-center flex-grow">${pageTitle}</h1>
                        <div class="w-48 text-right"></div>
                    </div>
                    ${mobileFilterButton}
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <aside id="filters-sidebar" class="hidden lg:block lg:col-span-1 bg-white/60 p-6 rounded-lg shadow-sm h-fit self-start"></aside>
                        <div id="product-grid-container" class="lg:col-span-3">
                            <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8"></div>
                        </div>
                    </div>
                </div>
                ${getFooterHTML()}`;
            
            applyFiltersAndRenderGrid();
            lucide.createIcons();
        };

        const createProductCard = (product) => {
            const isWished = db.wishlist.includes(product.id);
            const premiumTag = product.tags.includes('premium') ? `<div class="tag premium">Premium</div>` : '';
            const saleTag = !premiumTag && product.tags.includes('festive-sale') ? `<div class="tag bg-red-500 text-white">Sale</div>` : '';
            const newTag = !premiumTag && !saleTag && product.tags.includes('new-arrival') ? `<div class="tag bg-blue-500 text-white">New</div>` : '';
            const stockTag = product.stock === 0 ? `<div class="tag bg-gray-600 text-white">Sold Out</div>` : (!premiumTag && !saleTag && !newTag && product.stock < 10 ? `<div class="tag bg-yellow-500 text-black">Low Stock</div>` : '');

            const cartButtonHTML = product.stock > 0
                ? `<button data-id="${product.id}" class="add-to-cart-btn flex-grow bg-violet-600 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:bg-violet-700 transition-colors">Add to Cart</button>`
                : `<button class="flex-grow bg-gray-300 text-gray-500 text-sm font-semibold py-2 px-3 rounded-lg cursor-not-allowed">Sold Out</button>`;
            
            // Using the new heart-shape class
            const wishlistButtonHTML = `<button data-id="${product.id}" title="Add to Wishlist" class="wishlist-toggle-btn-card heart-shape ${isWished ? 'active' : ''}"><i data-lucide="heart" class="w-5 h-5 pointer-events-none"></i></button>`;

            return `
                <div class="product-card bg-white/80 backdrop-blur-sm group flex flex-col slide-in-up">
                    <div class="relative">
                        <div class="absolute top-0 left-0 p-4 w-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                             <div class="description-tooltip bg-gray-800 text-white text-xs rounded-md p-2 shadow-lg">${product.spec}</div>
                        </div>
                        ${premiumTag || saleTag || newTag || stockTag}
                        <a href="#" class="product-link" data-id="${product.id}">
                            <img src="${product.images[0]}" alt="${product.name}" class="w-full h-64 object-cover rounded-t-lg">
                        </a>
                        <div class="actions-overlay absolute inset-0 bg-black/40 flex items-center justify-center p-4 space-x-2 rounded-t-lg">
                            <button class="action-button quick-view-btn" data-id="${product.id}" style="transition-delay: 0.1s;" title="Quick View"><i data-lucide="eye" class="w-8 h-8 p-1.5 bg-white/80 rounded-full text-gray-800 pointer-events-none"></i></button>
                            ${product.stock > 0 ? `<button class="action-button add-to-cart-btn" data-id="${product.id}" style="transition-delay: 0.2s;" title="Add to Cart"><i data-lucide="shopping-cart" class="w-8 h-8 p-1.5 bg-white/80 rounded-full text-gray-800 pointer-events-none"></i></button>` : ''}
                            <button class="action-button wishlist-toggle-btn ${isWished ? 'active' : ''}" data-id="${product.id}" style="transition-delay: 0.3s;" title="Add to Wishlist"><i data-lucide="heart" class="w-8 h-8 p-1.5 bg-white/80 rounded-full pointer-events-none"></i></button>
                        </div>
                    </div>
                    <div class="p-4 flex-grow flex flex-col"> 
                        <h3 class="font-semibold truncate"><a href="#" class="product-link hover:text-violet-700" data-id="${product.id}">${product.name}</a></h3>
                        <p class="text-violet-700 font-bold">${'NPR ' + product.price.toLocaleString()}</p>
                        <div class="mt-auto pt-4 flex items-center gap-2">
                            ${cartButtonHTML}
                            ${wishlistButtonHTML}
                        </div>
                    </div>
                </div>`;
        };
        
        const renderModal = (content, maxWidth = 'max-w-md', isScrollable = false) => {
            const scrollClass = isScrollable ? 'modal-content-scroll' : '';
            modalContainer.innerHTML = `<div class="modal-backdrop fixed inset-0 flex p-4"><div class="modal-box bg-white rounded-lg shadow-xl w-full ${maxWidth} m-auto relative pop-in ${scrollClass}">${content}</div></div>`;
            modalContainer.style.display = "flex";
            modalContainer.classList.remove('pointer-events-none');
            lucide.createIcons();
        };

        const closeModal = () => {
            modalContainer.innerHTML = "";
            modalContainer.style.display = "none";
            modalContainer.classList.add('pointer-events-none');
        };

        const renderSidebar = (content) => {
            sidebarContainer.innerHTML = `<div class="fixed inset-0 bg-black/30 close-sidebar-btn"></div>${content}`;
            sidebarContainer.classList.remove('pointer-events-none');
            setTimeout(() => sidebarContainer.querySelector('.sidebar').classList.add('open'), 10);
            lucide.createIcons();
        };

        const closeSidebar = () => {
            const sidebar = sidebarContainer.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('open');
                setTimeout(() => {
                    sidebarContainer.innerHTML = "";
                    sidebarContainer.classList.add('pointer-events-none');
                }, 400);
            }
        };

        const renderCartSidebar = () => {
            let itemsHTML = `<div class="text-center my-8">
                                 <p class="text-gray-500 mb-4">Your cart is empty.</p>
                                 <button class="go-shopping-btn bg-violet-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-violet-700">Go Shopping</button>
                               </div>`;
            let subtotal = 0;
            if(db.cart.length > 0) {
                 itemsHTML = db.cart.map(item => {
                     const product = db.products.find(p => p.id === item.id);
                     subtotal += product.price * item.quantity;
                     return `
                         <div class="flex items-center justify-between mb-4">
                             <img src="${product.images[0]}" class="w-16 h-16 rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/600x600/cccccc/333333?text=Image+Not+Found';">
                             <div class="flex-grow">
                                 <h4 class="font-semibold text-sm">${product.name}</h4>
                                 <p class="text-xs text-gray-500">NPR ${product.price.toLocaleString()}</p>
                                 <div class="flex items-center border rounded-md w-fit mt-1">
                                      <button class="qty-change p-1" data-id="${item.id}" data-change="-1">-</button>
                                      <input type="number" value="${item.quantity}" class="w-8 text-center text-sm" readonly>
                                      <button class="qty-change p-1" data-id="${item.id}" data-change="1">+</button>
                                 </div>
                             </div>
                             <button class="remove-from-cart text-red-500 hover:text-red-700" data-id="${item.id}"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                         </div>`;
                 }).join('');
            }
            const content = `
                <div class="sidebar w-full max-w-sm bg-white shadow-2xl flex flex-col">
                    <div class="flex justify-between items-center p-6 border-b"><h2 class="text-2xl font-display flex items-center gap-2"><i data-lucide="shopping-bag"></i> Your Cart</h2><button class="close-sidebar-btn"><i data-lucide="x"></i></button></div>
                    <div class="flex-grow p-6 overflow-y-auto">${itemsHTML}</div>
                    <div class="p-6 border-t bg-gray-50">
                        <div class="flex justify-between font-bold text-lg mb-4"><span>Subtotal</span><span>NPR ${subtotal.toLocaleString()}</span></div>
                        <button id="checkout-btn" class="w-full bg-violet-600 text-white py-3 rounded-lg font-semibold hover:bg-violet-700 transition-colors mb-2 disabled:bg-gray-300 disabled:cursor-not-allowed" ${db.cart.length === 0 ? 'disabled' : ''}>Proceed to Checkout</button>
                        <button class="close-sidebar-btn w-full text-violet-600 font-semibold py-2 rounded-lg hover:bg-violet-100 transition-colors">Continue Shopping</button>
                    </div>
                </div>`;
            renderSidebar(content);
        };
        
        const renderWishlistSidebar = () => {
            let itemsHTML = `<div class="text-center my-8">
                                 <p class="text-gray-500 mb-4">Your wishlist is empty.</p>
                                 <button class="go-shopping-btn bg-violet-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-violet-700">Go Shopping</button>
                               </div>`;
            if(db.wishlist.length > 0) {
                 itemsHTML = db.wishlist.map(id => {
                     const product = db.products.find(p => p.id === id);
                     return `
                         <div class="flex items-center justify-between mb-4">
                             <img src="${product.images[0]}" class="w-16 h-16 rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/600x600/cccccc/333333?text=Image+Not+Found';">
                             <div class="flex-grow">
                                 <h4 class="font-semibold text-sm">${product.name}</h4>
                                 <p class="text-xs text-gray-500">NPR ${product.price.toLocaleString()}</p>
                             </div>
                             <button class="add-to-cart-btn text-violet-600 hover:text-violet-800" data-id="${product.id}" title="Move to Cart"><i data-lucide="shopping-cart" class="w-5 h-5"></i></button>
                         </div>`;
                 }).join('');
            }
            const content = `
                <div class="sidebar w-full max-w-sm bg-white shadow-2xl flex flex-col">
                    <div class="flex justify-between items-center p-6 border-b"><h2 class="text-2xl font-display flex items-center gap-2"><i data-lucide="heart"></i> Your Wishlist</h2><button class="close-sidebar-btn"><i data-lucide="x"></i></button></div>
                    <div class="flex-grow p-6 overflow-y-auto">${itemsHTML}</div>
                    <div class="p-6 border-t bg-gray-50">
                        <button class="close-sidebar-btn w-full text-violet-600 font-semibold py-3 rounded-lg hover:bg-violet-100 transition-colors">Continue Shopping</button>
                    </div>
                </div>`;
            renderSidebar(content);
        };

        const renderLoginModal = () => {
            const content = `
                <div class="p-8 text-center">
                    <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10"><i data-lucide="x"></i></button>
                    <h2 class="font-display text-3xl mb-2">Welcome Back</h2>
                    <p class="text-gray-600 mb-6">Log in to continue.</p>
                    <form id="login-form" class="text-left">
                        <input type="email" placeholder="Email Address" class="w-full p-2 border rounded mb-4" required>
                        <input type="password" placeholder="Password" class="w-full p-2 border rounded mb-4" required>
                        <button type="submit" class="w-full bg-violet-600 text-white py-3 rounded-lg font-semibold hover:bg-violet-700">Login</button>
                    </form>
                    <div class="text-sm text-gray-600 mt-4">
                        <p>Don't have an account? <a href="#" id="signup-link" class="font-semibold text-violet-600 hover:underline">Register here</a></p>
                        <button class="close-modal-btn text-sm text-violet-600 hover:underline mt-2">Or continue shopping</button>
                    </div>
                </div>`;
            renderModal(content);
        };

        const renderSignupModal = () => {
            const content = `
                <div class="p-8 text-center">
                     <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10"><i data-lucide="x"></i></button>
                    <h2 class="font-display text-3xl mb-2">Create Account</h2>
                    <p class="text-gray-600 mb-6">Join the Kalakar family.</p>
                    <form id="signup-form" class="text-left">
                        <input type="text" placeholder="Full Name" class="w-full p-2 border rounded mb-4" required>
                        <input type="email" placeholder="Email Address" class="w-full p-2 border rounded mb-4" required>
                        <input type="password" placeholder="Password" class="w-full p-2 border rounded mb-4" required>
                        <button type="submit" class="w-full bg-violet-600 text-white py-3 rounded-lg font-semibold hover:bg-violet-700">Register</button>
                    </form>
                    <div class="text-sm text-gray-600 mt-4">
                        <p>Already have an account? <a href="#" id="login-link" class="font-semibold text-violet-600 hover:underline">Login here</a></p>
                        <button class="close-modal-btn text-sm text-violet-600 hover:underline mt-2">Or continue shopping</button>
                    </div>
                </div>`;
            renderModal(content);
        }

        const renderCheckoutModal = () => {
            let subtotal = 0;
            const itemsSummary = db.cart.map(item => {
                const product = db.products.find(p => p.id === item.id);
                subtotal += product.price * item.quantity;
                return `<li class="flex justify-between text-sm py-1"><span class="text-gray-600">${item.quantity} x ${product.name}</span><span class="font-medium">NPR ${(item.quantity * product.price).toLocaleString()}</span></li>`;
            }).join('');
            
            state.deliveryCharge = 0; 

            const content = `
                <div class="p-6 md:p-8 flex flex-col h-full">
                    <div class="flex-shrink-0 mb-6 flex justify-between items-center">
                        <h2 class="font-display text-3xl">Checkout</h2>
                        <button class="close-modal-btn text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
                    </div>
                    <div class="flex-grow overflow-y-auto pr-2">
                        <form id="confirm-order-form">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div>
                                    <h3 class="font-semibold mb-4 text-lg">1. Shipping Details</h3>
                                    <div class="space-y-4">
                                        <input type="text" id="customer-name" placeholder="Full Name" class="block w-full border border-gray-300 rounded-md shadow-sm p-2" required value="${state.customerName !== 'Guest' ? state.customerName : ''}">
                                        <input type="text" id="customer-address" placeholder="Address" class="block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                                        <input type="tel" id="customer-phone" placeholder="Phone Number" class="block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                                    </div>
                                    <h3 class="font-semibold mt-6 mb-2 text-lg">2. Delivery Method</h3>
                                    <div id="delivery-options-container" class="space-y-2">
                                        <div class="delivery-option p-3 rounded-lg flex items-center gap-4" data-delivery-cost="120">
                                            <i data-lucide="truck" class="w-8 h-8 text-gray-600 pointer-events-none"></i>
                                            <div class="pointer-events-none"><h4 class="font-bold">Inside Valley Delivery</h4><p class="text-xs text-gray-500">NPR 120 (1-2 days)</p></div>
                                        </div>
                                        <div class="delivery-option p-3 rounded-lg flex items-center gap-4" data-delivery-cost="220">
                                            <i data-lucide="navigation" class="w-8 h-8 text-gray-600 pointer-events-none"></i>
                                            <div class="pointer-events-none"><h4 class="font-bold">Outside Valley Delivery</h4><p class="text-xs text-gray-500">NPR 220 (2-4 days)</p></div>
                                        </div>
                                        <div class="delivery-option p-3 rounded-lg flex items-center gap-4 opacity-50 cursor-not-allowed">
                                            <i data-lucide="globe" class="w-8 h-8 text-gray-600 pointer-events-none"></i>
                                            <div class="pointer-events-none"><h4 class="font-bold">International Shipping</h4><p class="text-xs text-red-500">Available soon</p></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold mb-4 text-lg">3. Order Summary</h3>
                                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                        <ul class="divide-y">${itemsSummary}</ul>
                                        <div class="flex justify-between text-sm py-1 border-t mt-2 pt-2"><span class="text-gray-600">Subtotal</span><span class="font-medium">NPR ${subtotal.toLocaleString()}</span></div>
                                        <div class="flex justify-between text-sm py-1"><span class="text-gray-600">Delivery Fee</span><span id="delivery-fee" class="font-medium">--</span></div>
                                        <div class="flex justify-between font-bold text-lg pt-2 mt-2 border-t"><span>Total</span><span id="total-amount">NPR ${subtotal.toLocaleString()}</span></div>
                                    </div>
                                    <h3 class="font-semibold mb-2 text-lg">4. Payment Method</h3>
                                    <div class="space-y-2">
                                        <div class="payment-option p-3 rounded-lg flex items-center gap-4 selected" data-method="cod">
                                            <i data-lucide="hand-coins" class="w-8 h-8 text-gray-600"></i>
                                            <div><h4 class="font-bold">Cash on Delivery</h4><p class="text-xs text-gray-500">Pay when your order arrives.</p></div>
                                        </div>
                                        <div class="payment-option p-3 rounded-lg flex items-center gap-4 opacity-50 cursor-not-allowed">
                                            <i data-lucide="credit-card" class="w-8 h-8 text-gray-600"></i>
                                            <div><h4 class="font-bold">eSewa</h4><p class="text-xs text-red-500">Available soon</p></div>
                                        </div>
                                        <div class="payment-option p-3 rounded-lg flex items-center gap-4 opacity-50 cursor-not-allowed">
                                            <i data-lucide="credit-card" class="w-8 h-8 text-gray-600"></i>
                                            <div><h4 class="font-bold">Khalti</h4><p class="text-xs text-red-500">Available soon</p></div>
                                        </div>
                                        <div class="payment-option p-3 rounded-lg flex items-center gap-4 opacity-50 cursor-not-allowed">
                                            <i data-lucide="smartphone" class="w-8 h-8 text-gray-600"></i>
                                            <div><h4 class="font-bold">Fonepay</h4><p class="text-xs text-red-500">Available soon</p></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                     <div class="mt-8 pt-6 border-t flex-shrink-0 flex items-center justify-end gap-4">
                        <button type="button" class="close-modal-btn font-semibold text-violet-600 hover:underline">Add More Items</button>
                        <button id="confirm-order-btn" type="submit" form="confirm-order-form" class="bg-violet-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-violet-700 transition-colors">Confirm Order</button>
                    </div>
                </div>`;
            renderModal(content, 'max-w-4xl', true);
        };
        
        const renderQuickViewModal = (product) => {
             const content = `
                <div class="flex flex-col md:flex-row">
                     <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10"><i data-lucide="x"></i></button>
                    <div class="w-full md:w-1/2 p-4"><img src="${product.images[0]}" alt="${product.name}" class="w-full h-full object-cover rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/600x600/cccccc/333333?text=Image+Not+Found';"></div>
                    <div class="w-full md:w-1/2 p-8 flex flex-col text-center md:text-left">
                         <div class="modal-content-scroll">
                            <h2 class="font-display text-3xl mb-2">${product.name}</h2>
                            <p class="text-2xl text-violet-700 font-bold mb-4">NPR ${product.price.toLocaleString()}</p>
                            <p class="text-gray-600 mb-6">${product.spec}</p>
                         </div>
                         <div class="mt-auto pt-6 flex flex-col items-center gap-4 w-full">
                             <button class="view-full-details-btn w-full bg-violet-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-violet-700 transition-colors" data-id="${product.id}">
                                 View Full Details
                             </button>
                         </div>
                    </div>
                </div>`;
             renderModal(content, 'max-w-4xl', true);
        };
        
        const renderMobileSearchModal = () => {
            const content = `
                <div class="p-4">
                    <form id="search-form-mobile" class="relative">
                        <input type="search" id="search-input-mobile" placeholder="Search for products..." class="w-full p-3 pl-10 border border-gray-300 rounded-full focus:ring-2 focus:ring-violet-300" autofocus>
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                    </form>
                </div>`;
            renderModal(content, 'max-w-md');
        };

        const renderProductDetailPage = (productId) => {
            const product = db.products.find(p => p.id === productId);
            if (!product) {
                navigate('home');
                return;
            };
            state.activeProduct = productId;
            state.activeCategory = product.mainCat;

            const relatedProducts = db.products.filter(p => p.mainCat === product.mainCat && p.id !== product.id).slice(0, 4);
            const relatedProductsHTML = relatedProducts.map(p => createProductCard(p)).join('');
            
            shopContent.classList.remove('hidden');
            categoryChoice.classList.add('hidden');

            shopContent.innerHTML = `
            <div class="container mx-auto px-4 py-12 slide-in-up">
                <button id="back-to-shop" class="flex items-center gap-2 text-violet-600 font-semibold hover:text-violet-800 mb-8">
                    <i data-lucide="arrow-left"></i> Back to Shop
                </button>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <div><img src="${product.images[0]}" alt="${product.name}" class="w-full rounded-lg shadow-lg"></div>
                    <div>
                        <h1 class="font-display text-4xl mb-2">${product.name}</h1>
                        <p class="text-3xl text-violet-700 font-bold mb-4">NPR ${product.price.toLocaleString()}</p>
                        <p class="text-gray-600 mb-6">${product.description}</p>
                        <p><strong>Availability:</strong> <span class="font-semibold ${product.stock > 0 ? 'text-green-600' : 'text-red-600'}">${product.stock > 0 ? 'In Stock' : 'Sold Out'}</span></p>
                        <div class="mt-8 flex items-center gap-4">
                            <button class="add-to-cart-btn flex-grow bg-violet-600 text-white py-3 px-8 rounded-lg font-semibold text-lg hover:bg-violet-700 transition-colors" data-id="${product.id}" ${product.stock === 0 ? 'disabled' : ''}>
                                <i data-lucide="shopping-cart" class="inline-block mr-2"></i> Add to Cart
                            </button>
                             <button title="Add to Wishlist" data-id="${product.id}" class="wishlist-toggle-btn p-3 border-2 rounded-lg hover:border-red-400 ${db.wishlist.includes(product.id) ? 'active' : ''}"><i data-lucide="heart" class="w-6 h-6 pointer-events-none"></i></button>
                        </div>
                    </div>
                </div>
                <div class="mt-16 border-t pt-8">
                    <h2 class="font-display text-3xl mb-8">You Might Also Like</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">${relatedProductsHTML}</div>
                </div>
            </div>
            ${getFooterHTML()}`;
            lucide.createIcons();
        };
        
        const renderOurStoryModal = () => {
             const content = `
                <div class="p-8 text-left modal-content-scroll">
                     <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10"><i data-lucide="x"></i></button>
                     <h2 class="font-display text-3xl mb-4 text-center">Our Story</h2>
                     <div class="text-gray-600 space-y-4">
                         <p>Kalakar was born from a dream—a dream held by our founder, <strong>Kunal Gupta</strong>, to bring the soul of Nepali craftsmanship to the world. Raised amidst the vibrant artistry of Kathmandu, Kunal developed a deep appreciation for the intricate skills passed down through generations. However, he also saw the severe challenges artisans faced, from economic instability to a lack of global recognition.</p>
                         <p>Despite facing his own set of hardships in a country grappling with change, Kunal was determined. He started Kalakar not just as a business, but as a movement. His vision was to create a sustainable platform that empowers local artisans, preserves our rich cultural heritage, and offers authentic, handcrafted treasures to you.</p>
                     </div>
                      <div class="mt-6 text-center">
                          <button class="close-modal-btn text-sm text-violet-600 hover:underline">Close</button>
                      </div>
                </div>`;
             renderModal(content, 'max-w-2xl', true);
        };

        const renderTrackOrderModal = () => {
            const content = `
                <div class="p-8 text-center">
                    <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10"><i data-lucide="x"></i></button>
                    <h2 class="font-display text-3xl mb-2">Track Your Order</h2>
                    <p class="text-gray-600 mb-6">Enter your Order ID to see its status.</p>
                    <form id="track-order-form" class="flex gap-2">
                        <input type="text" id="track-order-id" placeholder="e.g., KAL1" class="w-full p-2 border rounded" required>
                        <button type="submit" class="bg-violet-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-violet-700">Track</button>
                    </form>
                    <div id="order-status-result" class="mt-6 text-left"></div>
                </div>`;
            renderModal(content);
        };

        const renderContactModal = () => {
            const whatsappIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="text-white"><path d="M16.75 13.96c.25.13.41.2.52.28.14.1.23.22.33.35.08.1.15.22.2.33.05.13.07.25.07.38 0 .2-.06.4-.2.58-.14.18-.33.35-.56.48-.23.13-.5.25-.78.33-.28.08-.58.1-1.28.04-1.1-.1-2.16-.4-3.16-1-1-.6-1.85-1.34-2.55-2.2-1.03-1.26-1.6-2.6-1.7-3.9-.02-.3.04-.6.1-.88.06-.28.18-.55.33-.78.15-.23.35-.44.58-.6.23-.16.48-.3.75-.38.27-.08.5-.1.7-.1l.15.02c.3.04.58.12.82.27.24.14.45.32.6.52.15.2.28.4.38.62.1.22.15.42.15.63 0 .2-.04.4-.1.6-.08.2-.18.38-.3.53-.13.15-.28.28-.45.4-.17.12-.33.22-.5.3-.17.08-.32.15-.45.23-.13.08-.2.13-.2.13s-.08.05-.13.13c-.05.08-.07.15-.07.28 0 .3.2.58.52.82.33.24.68.45 1.05.6.37.15.72.28 1.05.38.33.1.65.16.95.16.25 0 .5-.04.7-.13.2-.1.4-.2.58-.33.18-.13.35-.28.48-.45.13-.17.25-.37.33-.58.08-.2.1-.4.1-.6.02-1.07-.48-1.95-1.2-2.62-.7-.68-1.55-1.1-2.5-1.25-.97-.15-1.9-.04-2.8.3-1.1.42-2.1 1.14-2.95 2.1s-1.4 2-1.78 3.06c-.38 1.05-.5 2.1-.38 3.15.13 1.05.5 2.05 1.1 3 .6.95 1.4 1.78 2.38 2.45 1 .68 2.05 1.15 3.18 1.4.28.05.55.08.83.08.57 0 1.12-.08 1.66-.22.54-.14 1.05-.37 1.5-.68.45-.3.85-.7 1.15-1.15.3-.45.5-.95.62-1.48.12-.53.16-1.08.1-1.6-.2-1.7-1.1-3.2-2.4-4.15-1.33-.95-2.9-1.28-4.34-1z"/></svg>`;
            const content = `
                <div class="p-8 text-left modal-content-scroll">
                     <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10"><i data-lucide="x"></i></button>
                     <h2 class="font-display text-3xl mb-2 text-center">Contact Us</h2>
                     <p class="text-gray-600 mb-6 text-center">Have a question? We'd love to hear from you.</p>

                     <a href="https://wa.me/9779811111111" target="_blank" rel="noopener noreferrer" class="mb-6 bg-green-500 text-white w-full flex items-center justify-center gap-3 py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">
                        ${whatsappIconSVG}
                        Chat on WhatsApp
                     </a>
                     
                     <p class="text-center text-gray-500 my-4">-- OR --</p>

                     <form id="contact-us-form">
                        <div class="space-y-4">
                            <input type="text" placeholder="Full Name" class="w-full p-2 border rounded" required>
                            <input type="text" placeholder="Email or Phone Number" class="w-full p-2 border rounded" required>
                            <select name="queryType" class="w-full p-2 border rounded bg-white" required>
                                <option value="" disabled selected>Select Nature of Query...</option>
                                <option value="General Query">General Query</option>
                                <option value="Order Delayed">Order Delayed</option>
                                <option value="Payment Issue">Payment Issue</option>
                                <option value="Complaint">Complaint</option>
                                <option value="Other">Other</option>
                            </select>
                            <textarea placeholder="Your Message..." rows="4" class="w-full p-2 border rounded" required></textarea>
                        </div>
                        <button type="submit" class="mt-6 w-full bg-violet-600 text-white py-3 rounded-lg font-semibold hover:bg-violet-700">Send Message</button>
                     </form>
                </div>`;
            renderModal(content, 'max-w-lg', true);
        };
        
        const getFilterContentHTML = () => {
            const products = db.products.filter(p => p.mainCat === state.activeCategory);
            if(products.length === 0) return '';
            
            const allTypes = [...new Set(products.map(p => p.category))];
            const allColors = [...new Set(products.flatMap(p => p.colors || []))];
            const allSizes = [...new Set(products.flatMap(p => p.sizes || []))];

            const typesHTML = allTypes.map(type => `<label class="flex items-center space-x-2 text-sm"><input type="checkbox" class="filter-type" value="${type}" ${state.filters.types.includes(type) ? 'checked' : ''}><span>${type}</span></label>`).join('');
            const colorsHTML = allColors.map(color => `<label class="flex items-center space-x-2 text-sm"><input type="checkbox" class="filter-color" value="${color}" ${state.filters.colors.includes(color) ? 'checked' : ''}><span>${color}</span></label>`).join('');
            const sizesHTML = allSizes.map(size => `<label class="flex items-center space-x-2 text-sm"><input type="checkbox" class="filter-size" value="${size}" ${state.filters.sizes.includes(size) ? 'checked' : ''}><span>${size}</span></label>`).join('');
            
            return `
                ${typesHTML.length > 0 ? `<div class="filter-section"><h3>Type</h3><div class="space-y-2">${typesHTML}</div></div>` : ''}
                <div class="filter-section">
                    <h3>Price Range</h3>
                    <input type="range" min="${state.filters.minPrice}" max="${state.filters.maxPrice}" value="${state.filters.currentMax}" id="price-range-slider">
                    <div class="flex justify-between text-xs mt-2">
                        <span>NPR ${state.filters.minPrice.toLocaleString()}</span>
                        <span id="price-range-value">NPR ${state.filters.currentMax.toLocaleString()}</span>
                    </div>
                </div>
                ${colorsHTML.length > 0 ? `<div class="filter-section"><h3>Color</h3><div class="space-y-2">${colorsHTML}</div></div>` : ''}
                ${sizesHTML.length > 0 ? `<div class="filter-section"><h3>Size</h3><div class="space-y-2">${sizesHTML}</div></div>` : ''}
                <div class="filter-section">
                    <h3>Availability</h3>
                    <label class="flex items-center space-x-2 text-sm"><input type="checkbox" id="filter-stock" ${state.filters.inStock ? 'checked' : ''}><span>In Stock Only</span></label>
                </div>
            `;
        };

        const renderMobileFilterModal = () => {
            const filterContent = getFilterContentHTML();
            const content = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="font-display text-2xl">Filters</h2>
                         <button class="close-modal-btn"><i data-lucide="x"></i></button>
                    </div>
                    <div id="mobile-filters-container">${filterContent}</div>
                    <div class="mt-6 flex flex-col gap-2">
                        <button id="apply-filters-btn" class="w-full bg-violet-600 text-white py-2 rounded-lg font-semibold">Apply Filters</button>
                        <button id="reset-filters-btn" class="w-full text-sm text-violet-600 hover:underline">Reset Filters</button>
                    </div>
                </div>`;
            renderModal(content, 'max-w-md', true);
        };


        // ===================================================================================
        // IV. CORE LOGIC & ACTIONS
        // ===================================================================================

        const resetFilters = (products) => {
            const prices = products.map(p => p.price);
            state.filters = {
                types: [], colors: [], sizes: [],
                inStock: false,
                minPrice: Math.min(0, ...prices),
                maxPrice: Math.max(100, ...prices),
                currentMax: Math.max(100, ...prices)
            };
        };

        const renderFilters = () => {
            const filtersSidebar = getEl('filters-sidebar');
            if (!filtersSidebar) return;
            const content = getFilterContentHTML();
            filtersSidebar.innerHTML = `${content}<button id="reset-filters-btn" class="w-full text-sm text-violet-600 hover:underline mt-4">Reset Filters</button>`;
        };

        const applyFiltersAndRenderGrid = (searchFilterFn = null) => {
            const productGrid = getEl('product-grid');
            if (!productGrid) return;

            let baseProducts = searchFilterFn 
                ? db.products.filter(searchFilterFn) 
                : state.activeCategory 
                    ? db.products.filter(p => p.mainCat === state.activeCategory)
                    : [];

            if (!searchFilterFn) renderFilters();

            const filteredProducts = baseProducts.filter(p => {
                const { types, colors, sizes, inStock, currentMax } = state.filters;
                if (inStock && p.stock === 0) return false;
                if (p.price > currentMax) return false;
                if (types.length > 0 && !types.includes(p.category)) return false;
                if (colors.length > 0 && !(p.colors || []).some(c => colors.includes(c))) return false;
                if (sizes.length > 0 && !(p.sizes || []).some(s => sizes.includes(s))) return false;
                return true;
            });
            
            productGrid.innerHTML = filteredProducts.map(p => createProductCard(p)).join('') || `<p class="col-span-full text-center text-gray-500">No products match your criteria.</p>`;
            lucide.createIcons();
        };

        const saveStateToLocalStorage = () => {
            const appState = { cart: db.cart, wishlist: db.wishlist, orders: db.orders, orderCounter: state.orderCounter, isLoggedIn: state.isLoggedIn, customerName: state.customerName };
            localStorage.setItem('kalakarState', JSON.stringify(appState));
        };

        const loadStateFromLocalStorage = () => {
            const savedState = localStorage.getItem('kalakarState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                db.cart = parsedState.cart || [];
                db.wishlist = parsedState.wishlist || [];
                db.orders = parsedState.orders || [];
                state.orderCounter = parsedState.orderCounter || 1;
                state.isLoggedIn = parsedState.isLoggedIn || false;
                state.customerName = parsedState.customerName || 'Guest';
            }
        };
        
        const updateCart = () => {
            const cartCount = db.cart.reduce((sum, item) => sum + item.quantity, 0);
            document.querySelectorAll('#cart-count, #mobile-cart-btn span').forEach(el => el.textContent = cartCount);
            if(sidebarContainer.querySelector('.sidebar')) renderCartSidebar();
            saveStateToLocalStorage();
        };

        const updateWishlist = () => {
            document.querySelectorAll('#wishlist-count, #mobile-wishlist-btn span').forEach(el => el.textContent = db.wishlist.length);
            document.querySelectorAll('.wishlist-toggle-btn, .wishlist-toggle-btn-card').forEach(btn => {
                btn.classList.toggle('active', db.wishlist.includes(btn.dataset.id));
            });
            if(sidebarContainer.querySelector('.sidebar')?.querySelector('h2')?.textContent.includes('Wishlist')) {
                renderWishlistSidebar();
            }
            saveStateToLocalStorage();
        };

        const handleAddToCart = (productId, quantity = 1) => {
            const product = db.products.find(p => p.id === productId);
            if (product.stock === 0) { showToast('Sorry, this item is sold out.', 'error'); return; }
            const existingItem = db.cart.find(i => i.id === productId);
            if (existingItem) {
                existingItem.quantity = Math.min(product.stock, existingItem.quantity + quantity);
            } else {
                db.cart.push({ id: productId, quantity: quantity });
            }
            if (db.wishlist.includes(productId)) { handleToggleWishlist(productId, false); }
            showToast(`${product.name} added to cart!`, 'success');
            updateCart();
            updateWishlist();
        };

        const handleQtyChange = (productId, change) => {
            const item = db.cart.find(i => i.id === productId);
            if (item) {
                const product = db.products.find(p => p.id === productId);
                item.quantity += change;
                if (item.quantity > product.stock) {
                    item.quantity = product.stock;
                    showToast('Cannot add more than available stock.', 'info');
                }
                if (item.quantity <= 0) { db.cart = db.cart.filter(i => i.id !== productId); }
                updateCart();
            }
        };

        const handleRemoveFromCart = (productId) => {
            db.cart = db.cart.filter(i => i.id !== productId);
            showToast('Item removed from cart', 'info');
            updateCart();
        };
        
        const handleToggleWishlist = (productId, showMsg = true) => {
            if (db.wishlist.includes(productId)) {
                db.wishlist = db.wishlist.filter(id => id !== productId);
                if (showMsg) showToast('Removed from wishlist', 'info');
            } else {
                db.wishlist.push(productId);
                if (showMsg) showToast('Added to wishlist!', 'success');
            }
            updateWishlist();
        };

        const updateCheckoutTotals = () => {
            const deliveryFeeEl = modalContainer.querySelector('#delivery-fee');
            const totalAmountEl = modalContainer.querySelector('#total-amount');
            if (!deliveryFeeEl || !totalAmountEl) return;

            let subtotal = db.cart.reduce((sum, item) => sum + (db.products.find(p => p.id === item.id).price * item.quantity), 0);
            const total = subtotal + state.deliveryCharge;
            
            deliveryFeeEl.textContent = `NPR ${state.deliveryCharge.toLocaleString()}`;
            totalAmountEl.textContent = `NPR ${total.toLocaleString()}`;
        };

        const updateFiltersFromUI = (container) => {
            state.filters.currentMax = parseInt(container.querySelector('#price-range-slider').value);
            state.filters.inStock = container.querySelector('#filter-stock').checked;
            state.filters.types = [...container.querySelectorAll('.filter-type:checked')].map(el => el.value);
            state.filters.colors = [...container.querySelectorAll('.filter-color:checked')].map(el => el.value);
            state.filters.sizes = [...container.querySelectorAll('.filter-size:checked')].map(el => el.value);
        };
        
        // ===================================================================================
        // V. EVENT LISTENERS & ROUTING
        // ===================================================================================
        
        const renderHome = () => {
            state.activeCategory = null;
            state.activeProduct = null;
            document.body.className = 'text-gray-800 default-bg';
            shopContent.classList.add('hidden');
            categoryChoice.classList.remove('hidden');
            categoryChoice.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center text-center p-6">
                    <h1 class="font-display text-4xl md:text-6xl text-violet-900 mb-4 slide-in-up">Namaste! Welcome to Kalakar</h1>
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-12 slide-in-up" style="animation-delay: 0.2s;">Choose your journey into authentic Nepali craftsmanship.</p>
                    <div class="container mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl pop-in">
                        <div class="category-choice-card cursor-pointer group relative rounded-lg overflow-hidden shadow-lg" data-category="Jewelry">
                          <img src="https://images.unsplash.com/photo-1599643478518-a784e5dc4c8f?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1887&q=80" class="w-full h-96 object-cover transition-transform duration-500 group-hover:scale-110">
                          <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h2 class="font-display text-4xl text-white">Jewelry</h2></div>
                        </div>
                        <div class="category-choice-card cursor-pointer group relative rounded-lg overflow-hidden shadow-lg" data-category="Cosmetics">
                          <img src="https://images.unsplash.com/photo-1598440947619-2c35fc9aa908?auto=format&fit=crop&q=80&w=1887" class="w-full h-96 object-cover transition-transform duration-500 group-hover:scale-110">
                          <div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h2 class="font-display text-4xl text-white">Cosmetics</h2></div>
                        </div>
                    </div>
                </div>`;
            document.querySelectorAll('#search-input-desktop').forEach(i => i.value = '');
            closeSidebar();
            window.scrollTo(0, 0);
            lucide.createIcons();
        };

        const navigate = (page, data, replace = false) => {
            const newState = { page, data };
            let path = window.location.pathname;
            let hash = '';

            if (page === 'category') hash = `#${data.toLowerCase()}`;
            else if (page === 'product') hash = `#product/${data}`;
            
            if (history.state?.page !== newState.page || history.state?.data !== newState.data) {
                if (replace) {
                    history.replaceState(newState, '', path + hash);
                } else {
                    history.pushState(newState, '', path + hash);
                }
            }
            
            route(page, data);
        };
        
        const route = (page, data) => {
            closeModal();
            closeSidebar();
            if (page === 'category') {
                renderShopLayout(data);
            } else if (page === 'product') {
                renderProductDetailPage(data);
            } else {
                renderHome();
            }
        };
        
        window.addEventListener('popstate', (event) => {
            if (event.state) {
                route(event.state.page, event.state.data);
            } else {
                route('home');
            }
        });

        const setupEventListeners = () => {
            // Main click handler for the entire app
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                
                if (target.classList.contains('modal-backdrop')) {
                    closeModal(); return;
                }
                
                if (target.closest('.modal-box')) {
                    const modalActionTarget = target.closest('.close-modal-btn, a, button, .delivery-option');
                    if (modalActionTarget) {
                        if (modalActionTarget.classList.contains('close-modal-btn')) { closeModal(); }
                        else if (modalActionTarget.id === 'signup-link') { closeModal(); renderSignupModal(); }
                        else if (modalActionTarget.id === 'login-link') { closeModal(); renderLoginModal(); }
                        else if (modalActionTarget.classList.contains('view-full-details-btn')) { closeModal(); navigate('product', modalActionTarget.dataset.id); }
                        else if (modalActionTarget.classList.contains('delivery-option')) {
                            if (modalActionTarget.classList.contains('opacity-50')) return;
                            state.deliveryCharge = parseInt(modalActionTarget.dataset.deliveryCost);
                            modalActionTarget.closest('.modal-box').querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
                            modalActionTarget.classList.add('selected');
                            updateCheckoutTotals(); // This was the missing call
                        }
                    }
                    return; // Stop further processing for clicks inside a modal
                }
                
                const interactiveEl = target.closest('button, a, div.category-choice-card');
                if (!interactiveEl) return;

                const id = interactiveEl.id;
                const classList = interactiveEl.classList;
                const dataId = interactiveEl.dataset.id;
                
                // --- Routing and Page Navigation ---
                if (classList.contains('category-choice-card') || classList.contains('category-link')) {
                    e.preventDefault(); navigate('category', interactiveEl.dataset.category);
                } else if (id === 'brand-logo' || classList.contains('go-shopping-btn') || id === 'back-to-categories') {
                    e.preventDefault(); navigate('home');
                } else if (id === 'back-to-shop') {
                    e.preventDefault(); navigate('category', state.activeCategory);
                } else if (classList.contains('product-link')) {
                    e.preventDefault(); navigate('product', dataId);
                }
                
                // --- Sidebar and Modal Triggers (Non-routing) ---
                else if (id === 'cart-btn' || id === 'mobile-cart-btn') { e.preventDefault(); renderCartSidebar(); }
                else if (id === 'wishlist-btn' || id === 'mobile-wishlist-btn') { e.preventDefault(); renderWishlistSidebar(); }
                else if (id === 'mobile-search-btn') { e.preventDefault(); renderMobileSearchModal(); }
                else if (id === 'mobile-filter-btn') { e.preventDefault(); renderMobileFilterModal(); }
                else if (id === 'login-btn') { e.preventDefault(); renderLoginModal(); }
                else if (id === 'our-story-link') { e.preventDefault(); renderOurStoryModal(); }
                else if (id === 'track-order-link') { e.preventDefault(); renderTrackOrderModal(); }
                else if (id === 'contact-us-link') { e.preventDefault(); renderContactModal(); }
                else if (id === 'logout-btn') {
                    e.preventDefault();
                    state.isLoggedIn = false; state.customerName = 'Guest';
                    saveStateToLocalStorage(); renderHeader(); showToast('You have been logged out.', 'info');
                } else if (classList.contains('close-sidebar-btn')) {
                    e.preventDefault(); closeSidebar();
                } else if (id === 'checkout-btn') { 
                    e.preventDefault(); closeSidebar(); renderCheckoutModal(); 
                }
                
                // --- Product Actions ---
                else if (classList.contains('add-to-cart-btn')) { e.preventDefault(); handleAddToCart(dataId); }
                else if (classList.contains('wishlist-toggle-btn') || classList.contains('wishlist-toggle-btn-card')) { e.preventDefault(); handleToggleWishlist(dataId); }
                else if (classList.contains('remove-from-cart')) { e.preventDefault(); handleRemoveFromCart(dataId); }
                else if (classList.contains('qty-change')) { e.preventDefault(); handleQtyChange(dataId, parseInt(interactiveEl.dataset.change)); }

                lucide.createIcons();
            });

            // --- Filter Event Listeners ---
            document.body.addEventListener('input', (e) => {
                 const container = e.target.closest('#filters-sidebar, #mobile-filters-container');
                 if (e.target.id === 'price-range-slider' && container) {
                    container.querySelector('#price-range-value').textContent = `NPR ${parseInt(e.target.value).toLocaleString()}`;
                    if(e.target.closest('#filters-sidebar')) {
                         updateFiltersFromUI(container); applyFiltersAndRenderGrid();
                    }
                 }
            });
            document.body.addEventListener('change', (e) => {
                 const container = e.target.closest('#filters-sidebar');
                 if(container && (e.target.classList.contains('filter-type') || e.target.classList.contains('filter-color') || e.target.classList.contains('filter-size') || e.target.id === 'filter-stock')) {
                    updateFiltersFromUI(container); applyFiltersAndRenderGrid();
                 }
            });

            // --- Form Submission Handler ---
            document.body.addEventListener('submit', (e) => {
                e.preventDefault();
                const formId = e.target.id;
                
                if (formId === 'search-form' || formId === 'search-form-mobile') {
                    const inputId = formId === 'search-form' ? 'search-input-desktop' : 'search-input-mobile';
                    const query = getEl(inputId).value.toLowerCase();
                    if (!query) return;
                    const searchFilterFn = p => p.name.toLowerCase().includes(query) || p.description.toLowerCase().includes(query) || p.tags.some(tag => tag.toLowerCase().includes(query));
                    if (formId === 'search-form-mobile') closeModal();
                    renderShopLayout('Search Results');
                    applyFiltersAndRenderGrid(searchFilterFn);
                }
                else if (formId === 'login-form' || formId === 'signup-form') {
                    const nameInput = e.target.querySelector('input[type="text"]');
                    state.isLoggedIn = true;
                    state.customerName = nameInput ? nameInput.value.split(' ')[0] : e.target.querySelector('input[type="email"]').value.split('@')[0];
                    closeModal();
                    saveStateToLocalStorage();
                    renderHeader();
                    showToast(`Welcome, ${state.customerName}!`, 'success');
                } else if (formId === 'confirm-order-form') {
                    const name = modalContainer.querySelector('#customer-name').value;
                    const address = modalContainer.querySelector('#customer-address').value;
                    const phone = modalContainer.querySelector('#customer-phone').value;
                    if (!name || !address || !phone) { showToast('Please fill in all shipping details.', 'error'); return; }
                    
                    const orderId = `KAL${state.orderCounter++}`;
                    db.orders.push({ id: orderId, customerName: name, address, phone, items: [...db.cart], status: 'Processing', date: new Date().toISOString() });
                    db.cart = [];
                    closeModal();
                    updateCart();
                    saveStateToLocalStorage();
                    showToast(`Order Confirmed! Your Order ID is ${orderId}.`, 'success');
                } else if (formId === 'track-order-form') {
                     const orderIdToTrack = modalContainer.querySelector('#track-order-id').value.toUpperCase();
                     const order = db.orders.find(o => o.id === orderIdToTrack);
                     modalContainer.querySelector('#order-status-result').innerHTML = order
                         ? `<p class="text-green-600 font-semibold">Order found! Status: <span class="bg-green-100 p-1 rounded">${order.status}</span></p>`
                         : `<p class="text-red-500 font-semibold">Order ID not found. Please check and try again.</p>`;
                } else if (formId === 'contact-us-form') {
                    closeModal();
                    showToast('Thank you! Your message has been received.', 'success');
                }
            });

             window.addEventListener('scroll', () => {
                  const totalHeight = document.documentElement.scrollHeight - window.innerHeight;
                  const progress = (window.scrollY / totalHeight) * 100;
                  const progressBar = getEl('scroll-progress-bar');
                  if (progressBar) progressBar.style.height = `${progress}%`;
                  
                  document.body.classList.toggle('scrolling', window.scrollY > 50);
             });
        };
        
        // ===================================================================================
        // VI. INITIALIZATION
        // ===================================================================================
        function init() {
            loadStateFromLocalStorage();
            renderHeader();
            setupEventListeners();
            
            // Initial routing based on URL hash
            const hash = window.location.hash;
            if (hash.startsWith('#product/')) {
                const productId = hash.substring(9);
                navigate('product', productId, true);
            } else if (hash && hash.length > 1) {
                const category = hash.substring(1).charAt(0).toUpperCase() + hash.substring(2);
                if (db.products.some(p => p.mainCat.toLowerCase() === category.toLowerCase())) {
                    navigate('category', category, true);
                } else {
                    navigate('home', null, true);
                }
            } else {
                navigate('home', null, true);
            }
            
            updateCart();
            updateWishlist();
        }

        init();
    });
    </script>
</body>
</html>
